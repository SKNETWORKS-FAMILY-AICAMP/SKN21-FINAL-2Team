# Backend ë””ë ‰í† ë¦¬ êµ¬ì¡° ë¶„ì„

> FastAPI ê¸°ë°˜ í•œêµ­ ì—¬í–‰ ì¶”ì²œ ì±—ë´‡ ë°±ì—”ë“œ ì„œë²„

---

## ğŸ“ ì „ì²´ ë””ë ‰í† ë¦¬ êµ¬ì¡°

```
backend/
â”œâ”€â”€ main.py                  # íŒ¨í‚¤ì§€ ì§„ì…ì  (placeholder)
â”œâ”€â”€ Dockerfile               # Docker ì´ë¯¸ì§€ ë¹Œë“œ ì„¤ì •
â”œâ”€â”€ requirements.txt         # pip ì˜ì¡´ì„± ëª©ë¡
â”œâ”€â”€ pyproject.toml           # í”„ë¡œì íŠ¸ ë©”íƒ€ë°ì´í„° (uv/PEP 517)
â”œâ”€â”€ .dockerignore            # Docker ë¹Œë“œ ì œì™¸ íŒŒì¼ ëª©ë¡
â”œâ”€â”€ .python-version          # Python ë²„ì „ ê³ ì • íŒŒì¼
â”œâ”€â”€ README.md                # í”„ë¡œì íŠ¸ ì„¤ëª…
â”‚
â”œâ”€â”€ app/                     # ì‹¤ì œ FastAPI ì• í”Œë¦¬ì¼€ì´ì…˜ íŒ¨í‚¤ì§€
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py              # FastAPI ì•± ìƒì„± ë° ë¼ìš°í„° ë“±ë¡
â”‚   â”œâ”€â”€ api/                 # HTTP ì—”ë“œí¬ì¸íŠ¸ (ë¼ìš°í„°)
â”‚   â”œâ”€â”€ core/                # ì„¤ì • ë° ë³´ì•ˆ ìœ í‹¸ë¦¬í‹°
â”‚   â”œâ”€â”€ database/            # DB ì—°ê²° ë° ìŠ¤í‚¤ë§ˆ ì´ˆê¸°í™”
â”‚   â”œâ”€â”€ models/              # SQLAlchemy ORM ëª¨ë¸
â”‚   â”œâ”€â”€ schemas/             # Pydantic ìš”ì²­/ì‘ë‹µ ìŠ¤í‚¤ë§ˆ
â”‚   â”œâ”€â”€ services/            # LLM í˜¸ì¶œ ë° í”„ë¡¬í”„íŠ¸ ê´€ë¦¬
â”‚   â”œâ”€â”€ retrieval/           # Qdrant ë²¡í„° ê²€ìƒ‰ ë¡œì§
â”‚   â””â”€â”€ scripts/             # ë°ì´í„° ì „ì²˜ë¦¬ ë° Qdrant ì´ˆê¸° ì ì¬ ìŠ¤í¬ë¦½íŠ¸
â”‚
â”œâ”€â”€ data/
â”‚   â””â”€â”€ visitkorea_data.json # í•œêµ­ê´€ê´‘ê³µì‚¬ ê´€ê´‘ì§€ ì›ë³¸ ë°ì´í„°
â”‚
â””â”€â”€ tests/                   # pytest í…ŒìŠ¤íŠ¸ ì½”ë“œ
    â”œâ”€â”€ conftest.py
    â”œâ”€â”€ test_auth.py
    â”œâ”€â”€ test_chat.py
    â””â”€â”€ test_users.py
```

---

## ğŸ—‚ï¸ ë£¨íŠ¸ íŒŒì¼

### `main.py`
íŒ¨í‚¤ì§€ ë ˆë²¨ì˜ ì§„ì…ì  placeholder íŒŒì¼ì…ë‹ˆë‹¤. ì‹¤ì œ ì„œë²„ ì‹¤í–‰ì€ `app/main.py`ë¥¼ í†µí•´ ì´ë£¨ì–´ì§‘ë‹ˆë‹¤.

```python
def main():
    print("Hello from backend!")
```

---

### `Dockerfile`
Docker ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•˜ëŠ” ì„¤ì • íŒŒì¼ì…ë‹ˆë‹¤.

| í•­ëª©          | ë‚´ìš©                                              |
| ------------- | ------------------------------------------------- |
| ë² ì´ìŠ¤ ì´ë¯¸ì§€ | `python:3.11-slim`                                |
| ì‘ì—… ë””ë ‰í† ë¦¬ | `/app`                                            |
| ì˜ì¡´ì„± ì„¤ì¹˜   | `requirements.txt` ê¸°ë°˜ pip install               |
| ì¶”ê°€ íŒ¨í‚¤ì§€   | `git` (apt-get)                                   |
| ì‹¤í–‰ í¬íŠ¸     | `8000`                                            |
| ì‹¤í–‰ ëª…ë ¹     | `uvicorn app.main:app --host 0.0.0.0 --port 8000` |

---

### `requirements.txt`
pipë¡œ ì„¤ì¹˜ë˜ëŠ” ì˜ì¡´ì„± ëª©ë¡ì…ë‹ˆë‹¤.

| ë¶„ë¥˜          | ë¼ì´ë¸ŒëŸ¬ë¦¬                                                    |
| ------------- | ------------------------------------------------------------- |
| ì›¹ í”„ë ˆì„ì›Œí¬ | `fastapi`, `uvicorn`, `python-multipart`                      |
| ë°ì´í„° ê²€ì¦   | `pydantic`, `pydantic[email]`                                 |
| LLM           | `openai`, `langsmith`                                         |
| DB (MySQL)    | `pymysql`, `sqlalchemy`, `pydbml`                             |
| ì¸ì¦          | `python-jose[cryptography]`, `passlib[bcrypt]`, `google-auth` |
| ë²¡í„° DB       | `qdrant-client`, `sentence-transformers`                      |
| ì´ë¯¸ì§€ ì²˜ë¦¬   | `pillow`                                                      |
| í…ŒìŠ¤íŠ¸        | `pytest`, `httpx`, `pytest-asyncio`                           |
| ê¸°íƒ€          | `python-dotenv`, `tqdm`, `requests`                           |

---

### `pyproject.toml`
PEP 517 ê¸°ë°˜ í”„ë¡œì íŠ¸ ë©”íƒ€ë°ì´í„° íŒŒì¼ì…ë‹ˆë‹¤. `uv` íŒ¨í‚¤ì§€ ë§¤ë‹ˆì € ì‚¬ìš©ì„ ì „ì œë¡œ í•µì‹¬ ì˜ì¡´ì„±ì„ ëª…ì‹œí•©ë‹ˆë‹¤.

- Python ë²„ì „: `>=3.13`
- í•µì‹¬ ì˜ì¡´ì„±: `pillow`, `python-dotenv`, `qdrant-client`, `requests`, `sentence-transformers`

> âš ï¸ `requirements.txt`ì™€ ì¼ë¶€ ì¤‘ë³µë˜ë‚˜, `pyproject.toml`ì€ ë°°í¬ìš© ìµœì†Œ ì˜ì¡´ì„±ë§Œ í¬í•¨í•©ë‹ˆë‹¤.

---

## ğŸ“¦ `app/` â€” FastAPI ì• í”Œë¦¬ì¼€ì´ì…˜

### `app/main.py`
FastAPI ì•±ì˜ í•µì‹¬ ì§„ì…ì ì…ë‹ˆë‹¤.

**ì£¼ìš” ì—­í• :**
- `FastAPI()` ì•± ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
- **CORS ë¯¸ë“¤ì›¨ì–´** ì„¤ì • (í”„ë¡ íŠ¸ì—”ë“œ `localhost:3000` í—ˆìš©)
- ì„¸ ê°œì˜ ë¼ìš°í„° ë“±ë¡: `auth`, `users`, `chat`
- **HTTP ìš”ì²­ ë¡œê¹… ë¯¸ë“¤ì›¨ì–´**: ë©”ì„œë“œ, ê²½ë¡œ, ìƒíƒœì½”ë“œ, ì‘ë‹µì‹œê°„(ms) ê¸°ë¡
- `GET /` í—¬ìŠ¤ì²´í¬ ì—”ë“œí¬ì¸íŠ¸

---

## ğŸ“ `app/core/` â€” í•µì‹¬ ì„¤ì • ë° ë³´ì•ˆ

### `app/core/config.py`
ì „ì—­ ì„¤ì • ìƒìˆ˜ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.

| ìƒìˆ˜                | ì„¤ëª…                                             |
| ------------------- | ------------------------------------------------ |
| `DEVICE`            | ì¶”ë¡  ë””ë°”ì´ìŠ¤ ìë™ ê°ì§€ (`cuda` â†’ `mps` â†’ `cpu`) |
| `VECTOR_SIZE`       | ì„ë² ë”© ë²¡í„° ì°¨ì› ìˆ˜ (`512`)                      |
| `PLACES_COLLECTION` | Qdrant ì¥ì†Œ ì»¬ë ‰ì…˜ ì´ë¦„ (`"places"`)             |
| `PHOTOS_COLLECTION` | Qdrant ì‚¬ì§„ ì»¬ë ‰ì…˜ ì´ë¦„ (`"photos"`)             |

---

### `app/core/security.py`
JWT ì¸ì¦ ë° Google OAuth ì²˜ë¦¬ë¥¼ ë‹´ë‹¹í•©ë‹ˆë‹¤.

**JWT ê´€ë ¨:**
| í•¨ìˆ˜                            | ì„¤ëª…                                                       |
| ------------------------------- | ---------------------------------------------------------- |
| `create_access_token(user_id)`  | 15ë¶„ ë§Œë£Œ Access Token ìƒì„± (HS256)                        |
| `create_refresh_token(user_id)` | 7ì¼ ë§Œë£Œ Refresh Token ìƒì„±                                |
| `get_current_user(token, db)`   | Access Token ê²€ì¦ í›„ í˜„ì¬ ì‚¬ìš©ì ë°˜í™˜ (FastAPI Dependency) |
| `verify_refresh_token(token)`   | Refresh Token ìœ íš¨ì„± ê²€ì¦ í›„ ì´ë©”ì¼ ë°˜í™˜                   |

**Google OAuth ê´€ë ¨:**
| í•¨ìˆ˜                            | ì„¤ëª…                                                        |
| ------------------------------- | ----------------------------------------------------------- |
| `verify_google_auth_code(code)` | Google Authorization Codeë¥¼ í† í°ìœ¼ë¡œ êµí™˜í•˜ê³  ID Token ê²€ì¦ |

- `JWT_SECRET_KEY`: `.env`ì—ì„œ ë¡œë“œ, ì—†ìœ¼ë©´ ëœë¤ ìƒì„±
- `GOOGLE_REDIRECT_URI`: `"postmessage"` (íŒì—… ë°©ì‹ OAuth)

---

## ğŸ“ `app/api/` â€” HTTP ì—”ë“œí¬ì¸íŠ¸

### `app/api/auth.py`
ì¸ì¦ ê´€ë ¨ API ë¼ìš°í„° (`/api/auth`)

| ì—”ë“œí¬ì¸íŠ¸                  | ë©”ì„œë“œ | ì„¤ëª…                                                                                                              |
| --------------------------- | ------ | ----------------------------------------------------------------------------------------------------------------- |
| `/api/auth/google/callback` | POST   | Google Auth Codeë¡œ ë¡œê·¸ì¸. ì‹ ê·œ ì‚¬ìš©ì ìë™ ìƒì„±. Access/Refresh Token ë°œê¸‰. Refresh Tokenì€ HttpOnly ì¿ í‚¤ì— ì €ì¥ |
| `/api/auth/refresh`         | POST   | Refresh Tokenìœ¼ë¡œ ìƒˆ Access Token ë°œê¸‰                                                                            |
| `/api/auth/logout`          | POST   | `refresh_token` ì¿ í‚¤ ì‚­ì œ                                                                                         |

---

### `app/api/users.py`
ì‚¬ìš©ì ì •ë³´ API ë¼ìš°í„° (`/api/users`)

| ì—”ë“œí¬ì¸íŠ¸      | ë©”ì„œë“œ | ì„¤ëª…                                          |
| --------------- | ------ | --------------------------------------------- |
| `/api/users/me` | GET    | í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ                  |
| `/api/users/me` | PATCH  | í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ìˆ˜ì • (ì´ë¦„, ì„±ë³„, ì„ í˜¸ë„ ë“±) |

---

### `app/api/chat.py`
ì±„íŒ… API ë¼ìš°í„° (`/api/chat`)

| ì—”ë“œí¬ì¸íŠ¸                                 | ë©”ì„œë“œ | ì„¤ëª…                                                                                |
| ------------------------------------------ | ------ | ----------------------------------------------------------------------------------- |
| `/api/chat/rooms`                          | GET    | ë‚´ ì±„íŒ…ë°© ëª©ë¡ ì¡°íšŒ (ìµœì‹ ìˆœ)                                                        |
| `/api/chat/rooms`                          | POST   | ìƒˆ ì±„íŒ…ë°© ìƒì„±                                                                      |
| `/api/chat/rooms/{room_id}`                | GET    | ì±„íŒ…ë°© ìƒì„¸ ì¡°íšŒ (ë©”ì‹œì§€ í¬í•¨)                                                      |
| `/api/chat/messages`                       | POST   | ë©”ì‹œì§€ ì €ì¥ (ë‹¨ìˆœ ì €ì¥, LLM í˜¸ì¶œ ì—†ìŒ)                                              |
| `/api/chat/messages/{message_id}/bookmark` | PATCH  | ë©”ì‹œì§€ ë¶ë§ˆí¬ í† ê¸€                                                                  |
| `/api/chat/rooms/{room_id}/ask`            | POST   | **í•µì‹¬ ì—”ë“œí¬ì¸íŠ¸**: ì‚¬ìš©ì ë©”ì‹œì§€ ì €ì¥ â†’ RAG ê²€ìƒ‰ â†’ LLM ì‘ë‹µ ìƒì„± â†’ AI ë©”ì‹œì§€ ì €ì¥ |

**`/ask` ì—”ë“œí¬ì¸íŠ¸ ì²˜ë¦¬ íë¦„:**
1. ì±„íŒ…ë°© ì†Œìœ ê¶Œ í™•ì¸
2. ì‚¬ìš©ì ë©”ì‹œì§€ DB ì €ì¥
3. ë°© ì œëª© ìë™ ì„¤ì • (ì²« ë©”ì‹œì§€ ê¸°ì¤€, ìµœëŒ€ 30ì)
4. `retrieval_place()`ë¡œ Qdrantì—ì„œ ê´€ë ¨ ì¥ì†Œ ê²€ìƒ‰ (Context ìƒì„±)
5. `generate_response()`ë¡œ GPT-4o-mini í˜¸ì¶œ
6. AI ì‘ë‹µ ë©”ì‹œì§€ DB ì €ì¥ í›„ ë°˜í™˜

---

## ğŸ“ `app/models/` â€” SQLAlchemy ORM ëª¨ë¸

### `app/models/orm.py`
ëª¨ë“  ëª¨ë¸ì˜ ì¶”ìƒ ë² ì´ìŠ¤ í´ë˜ìŠ¤ `BaseModel`ì„ ì •ì˜í•©ë‹ˆë‹¤. `app.database.connection.Base`ë¥¼ ìƒì†í•©ë‹ˆë‹¤.

---

### `app/models/enums.py`
DBì—ì„œ ì‚¬ìš©í•˜ëŠ” Enum íƒ€ì…ì„ ì •ì˜í•©ë‹ˆë‹¤.

| Enum         | ê°’                        |
| ------------ | ------------------------- |
| `GenderType` | `male`, `female`, `other` |
| `RoleType`   | `human`, `ai`             |

---

### `app/models/user.py`
`users` í…Œì´ë¸” ORM ëª¨ë¸ì…ë‹ˆë‹¤.

| ì»¬ëŸ¼                                        | ì„¤ëª…                            |
| ------------------------------------------- | ------------------------------- |
| `id`                                        | PK (ìë™ ì¦ê°€)                  |
| `email`                                     | ì´ë©”ì¼ (ìœ ë‹ˆí¬)                 |
| `name`                                      | ì´ë¦„                            |
| `gender`                                    | ì„±ë³„ (`GenderType` Enum)        |
| `social_provider`                           | ì†Œì…œ ë¡œê·¸ì¸ ì œê³µì (`"google"`) |
| `social_id`                                 | ì†Œì…œ ê³ ìœ  ID                    |
| `social_access_token`                       | Google Access Token             |
| `social_refresh_token`                      | Google Refresh Token            |
| `actor/movie/drama/celeb/variety_prefer_id` | ì¹´í…Œê³ ë¦¬ë³„ ì„ í˜¸ë„ FK            |
| `with_yn`                                   | ë™ë°˜ì ì—¬ë¶€                     |
| `dog_yn`                                    | ë°˜ë ¤ê²¬ ë™ë°˜ ì—¬ë¶€                |
| `vegan_yn`                                  | ì±„ì‹ì£¼ì˜ì ì—¬ë¶€                 |
| `is_join`                                   | íšŒì›ê°€ì… ì™„ë£Œ ì—¬ë¶€              |
| `is_prefer`                                 | ì„ í˜¸ë„ ì„¤ì • ì™„ë£Œ ì—¬ë¶€           |

**ê´€ê³„:** `rooms` â†’ `ChatRoom` (1:N)

---

### `app/models/chat.py`
ì±„íŒ…ë°©ê³¼ ë©”ì‹œì§€ ORM ëª¨ë¸ì…ë‹ˆë‹¤.

**`ChatRoom` (`chat_rooms` í…Œì´ë¸”):**
| ì»¬ëŸ¼         | ì„¤ëª…                   |
| ------------ | ---------------------- |
| `id`         | PK                     |
| `user_id`    | ì†Œìœ ì FK (`users.id`) |
| `title`      | ì±„íŒ…ë°© ì œëª©            |
| `created_at` | ìƒì„± ì‹œê°              |

**`ChatMessage` (`chat_messages` í…Œì´ë¸”):**
| ì»¬ëŸ¼          | ì„¤ëª…                               |
| ------------- | ---------------------------------- |
| `id`          | PK                                 |
| `room_id`     | ì±„íŒ…ë°© FK                          |
| `message`     | ë©”ì‹œì§€ ë‚´ìš© (Text)                 |
| `role`        | ë°œí™”ì (`human` / `ai`)            |
| `latitude`    | ìœ„ë„ (ì„ íƒ)                        |
| `longitude`   | ê²½ë„ (ì„ íƒ)                        |
| `image_path`  | ì´ë¯¸ì§€ (LONGTEXT, Base64 ë˜ëŠ” URL) |
| `bookmark_yn` | ë¶ë§ˆí¬ ì—¬ë¶€                        |

---

### `app/models/prefer.py`
ì„ í˜¸ë„ ë§ˆìŠ¤í„° ë°ì´í„° ORM ëª¨ë¸ì…ë‹ˆë‹¤ (`prefers` í…Œì´ë¸”).

| ì»¬ëŸ¼         | ì„¤ëª…                                                     |
| ------------ | -------------------------------------------------------- |
| `id`         | PK                                                       |
| `category`   | ì¹´í…Œê³ ë¦¬ (`actor`, `movie`, `drama`, `celeb`, `variety`) |
| `type`       | ì„¸ë¶€ íƒ€ì…                                                |
| `value`      | ì„ í˜¸ë„ ê°’                                                |
| `image_path` | ëŒ€í‘œ ì´ë¯¸ì§€ ê²½ë¡œ                                         |

---

## ğŸ“ `app/schemas/` â€” Pydantic ìŠ¤í‚¤ë§ˆ

### `app/schemas/user.py`
ì‚¬ìš©ì ê´€ë ¨ ìš”ì²­/ì‘ë‹µ ìŠ¤í‚¤ë§ˆì…ë‹ˆë‹¤.

| ìŠ¤í‚¤ë§ˆ               | ìš©ë„                                       |
| -------------------- | ------------------------------------------ |
| `UserBase`           | ê¸°ë³¸ ì‚¬ìš©ì í•„ë“œ                           |
| `UserUpdate`         | ì‚¬ìš©ì ì •ë³´ ìˆ˜ì • ìš”ì²­ (ëª¨ë“  í•„ë“œ Optional) |
| `UserResponse`       | ì‚¬ìš©ì ì •ë³´ ì‘ë‹µ                           |
| `Token`              | Access + Refresh Token ì‘ë‹µ                |
| `TokenData`          | JWT í˜ì´ë¡œë“œ ë‚´ ë°ì´í„°                     |
| `GoogleLoginRequest` | Google Auth Code ìš”ì²­ (`code` í•„ë“œ)        |
| `RefreshRequest`     | Refresh Token ê°±ì‹  ìš”ì²­                    |

---

### `app/schemas/chat.py`
ì±„íŒ… ê´€ë ¨ ìš”ì²­/ì‘ë‹µ ìŠ¤í‚¤ë§ˆì…ë‹ˆë‹¤.

| ìŠ¤í‚¤ë§ˆ                | ìš©ë„                                               |
| --------------------- | -------------------------------------------------- |
| `ChatMessageBase`     | ë©”ì‹œì§€ ê¸°ë³¸ í•„ë“œ (message, ìœ„ê²½ë„, ì´ë¯¸ì§€, ë¶ë§ˆí¬) |
| `ChatMessageCreate`   | ë©”ì‹œì§€ ìƒì„± ìš”ì²­ (room_id, role í¬í•¨)              |
| `ChatMessageResponse` | ë©”ì‹œì§€ ì‘ë‹µ (id, created_at í¬í•¨)                  |
| `ChatRoomBase`        | ì±„íŒ…ë°© ê¸°ë³¸ í•„ë“œ (title)                           |
| `ChatRoomCreate`      | ì±„íŒ…ë°© ìƒì„± ìš”ì²­                                   |
| `ChatRoomResponse`    | ì±„íŒ…ë°© ì‘ë‹µ (messages ëª©ë¡ í¬í•¨)                   |

---

## ğŸ“ `app/services/` â€” LLM ì„œë¹„ìŠ¤

### `app/services/prompts.py`
GPTì—ê²Œ ì „ë‹¬í•˜ëŠ” ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.

AIì˜ ì—­í• : **ì´ˆê°œì¸í™” í•œêµ­ ì—¬í–‰ ì—ì´ì „íŠ¸**

**í•µì‹¬ í–‰ë™ ì›ì¹™:**
1. **RAG ìš°ì„ **: ì œê³µëœ Context Informationì„ ìµœìš°ì„ ìœ¼ë¡œ ì‚¬ìš©
2. **ì´ˆê°œì¸í™”**: ì‚¬ìš©ì ì·¨í–¥, ì—¬í–‰ ëª©ì , ëŒ€í™” ë§¥ë½ ë°˜ì˜
3. **ë©€í‹°ëª¨ë‹¬**: ì´ë¯¸ì§€ ë¶„ì„ì„ í†µí•œ ìœ ì‚¬ ì¥ì†Œ ì¶”ì²œ
4. **ì‹¤í–‰ ê°€ëŠ¥í•œ ì •ë³´**: ì¥ì†Œ íŠ¹ì§•, ì¶”ì²œ ì´ìœ , ë°©ë¬¸ íŒ í¬í•¨
5. **ì£¼ë³€ ì¶”ì²œ**: Contextì˜ `Nearby Places` ì •ë³´ í™œìš©

ì‘ë‹µ ìŠ¤íƒ€ì¼: í•œêµ­ì–´, í•´ìš”ì²´, Markdown í˜•ì‹

---

### `app/services/llm.py`
OpenAI APIë¥¼ í˜¸ì¶œí•˜ëŠ” í•¨ìˆ˜ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

**`generate_response(user_input, image, location, context)`**

| íŒŒë¼ë¯¸í„°     | ì„¤ëª…                                 |
| ------------ | ------------------------------------ |
| `user_input` | ì‚¬ìš©ì ì§ˆë¬¸ í…ìŠ¤íŠ¸                   |
| `image`      | Base64 ë˜ëŠ” URL í˜•ì‹ ì´ë¯¸ì§€ (ì„ íƒ)   |
| `location`   | `"ìœ„ë„, ê²½ë„"` í˜•ì‹ í˜„ì¬ ìœ„ì¹˜ (ì„ íƒ) |
| `context`    | RAG ê²€ìƒ‰ ê²°ê³¼ ë¬¸ìì—´ (ì„ íƒ)          |

- ì‚¬ìš© ëª¨ë¸: `gpt-4o-mini`
- ë©”ì‹œì§€ êµ¬ì„± ìˆœì„œ: System Prompt â†’ Context â†’ ìœ„ì¹˜ â†’ ì‚¬ìš©ì ì§ˆë¬¸ â†’ ì´ë¯¸ì§€
- ì˜¤ë¥˜ ë°œìƒ ì‹œ `"ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."` ë°˜í™˜

---

## ğŸ“ `app/retrieval/` â€” ë²¡í„° ê²€ìƒ‰

### `app/retrieval/place.py`
Qdrant ë²¡í„° DBì—ì„œ ê´€ê´‘ì§€ë¥¼ ê²€ìƒ‰í•˜ëŠ” í•µì‹¬ ëª¨ë“ˆì…ë‹ˆë‹¤.

**`PlaceRetriever` í´ë˜ìŠ¤ (ì‹±ê¸€í†¤ íŒ¨í„´):**

| ë©”ì„œë“œ                                          | ì„¤ëª…                                                          |
| ----------------------------------------------- | ------------------------------------------------------------- |
| `search_text(query, limit)`                     | í…ìŠ¤íŠ¸ ì„ë² ë”©ìœ¼ë¡œ `places` ì»¬ë ‰ì…˜ì˜ `text_vec` ê²€ìƒ‰           |
| `search_image(image_url, limit)`                | ì´ë¯¸ì§€ ì„ë² ë”©ìœ¼ë¡œ `photos` ì»¬ë ‰ì…˜ ê²€ìƒ‰ í›„ `place_id`ë¡œ ê·¸ë£¹í™” |
| `search_hybrid(query, image_url, limit, alpha)` | í…ìŠ¤íŠ¸+ì´ë¯¸ì§€ ê°€ì¤‘í•© í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰ (alpha: í…ìŠ¤íŠ¸ ê°€ì¤‘ì¹˜)   |
| `search_nearby(lat, lng, limit, radius_km)`     | Haversine ê³µì‹ìœ¼ë¡œ ë°˜ê²½ ë‚´ ì¥ì†Œ ê²€ìƒ‰                          |
| `_haversine(lat1, lon1, lat2, lon2)`            | ë‘ ì¢Œí‘œ ê°„ ê±°ë¦¬(km) ê³„ì‚°                                      |

**ì„ë² ë”© ëª¨ë¸:** `clip-ViT-B-32` (í…ìŠ¤íŠ¸/ì´ë¯¸ì§€ ëª¨ë‘ 512ì°¨ì›)

**`retrieval_place(message_in)` í•¨ìˆ˜:**
1. `search_hybrid()`ë¡œ ìƒìœ„ 3ê°œ ì¥ì†Œ ê²€ìƒ‰
2. ìµœìƒìœ„ ê²°ê³¼ì˜ ì¢Œí‘œ ê¸°ì¤€ ë°˜ê²½ 5km ë‚´ ì£¼ë³€ ì¥ì†Œ ì¶”ê°€ ê²€ìƒ‰
3. ê²°ê³¼ë¥¼ Markdown í˜•ì‹ ë¬¸ìì—´ë¡œ í¬ë§·í•˜ì—¬ ë°˜í™˜ (LLM Contextë¡œ í™œìš©)

---

## ğŸ“ `app/database/` â€” ë°ì´í„°ë² ì´ìŠ¤

### `app/database/connection.py`
MySQL ì—°ê²° ì„¤ì • ë° SQLAlchemy ì„¸ì…˜ ê´€ë¦¬ë¥¼ ë‹´ë‹¹í•©ë‹ˆë‹¤.

- `.env`ì—ì„œ `MYSQL_USER`, `MYSQL_PASSWORD`, `MYSQL_HOST`, `MYSQL_PORT`, `MYSQL_DATABASE` ë¡œë“œ
- `pool_pre_ping=True`: ì—°ê²° ìœ íš¨ì„± ì‚¬ì „ í™•ì¸
- `pool_recycle=3600`: 1ì‹œê°„ë§ˆë‹¤ ì—°ê²° ì¬ìƒì„±
- `get_db()`: FastAPI Dependencyë¡œ ì‚¬ìš©í•˜ëŠ” DB ì„¸ì…˜ ì œê³µ í•¨ìˆ˜

---

### `app/database/create_db.py`
DBML ìŠ¤í‚¤ë§ˆ ì •ì˜ë¥¼ íŒŒì‹±í•˜ì—¬ MySQL í…Œì´ë¸”ì„ ìë™ ìƒì„±í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤.

**ë‚´ì¥ DBML ìŠ¤í‚¤ë§ˆ ì •ì˜ í…Œì´ë¸”:**
- `users`: íšŒì› ì •ë³´
- `prefers`: ì„ í˜¸ë„ ë§ˆìŠ¤í„°
- `chat_rooms`: ì±„íŒ…ë°©
- `chat_messages`: ì±„íŒ… ë©”ì‹œì§€
- `country`: êµ­ê°€ ì½”ë“œ

**`deploy_db_from_dbml()` í•¨ìˆ˜ ì²˜ë¦¬ ê³¼ì •:**
1. DBML â†’ SQL íŒŒì‹± (`PyDBML`)
2. PostgreSQL ENUM â†’ MySQL ENUM ë³€í™˜
3. ìŒë”°ì˜´í‘œ â†’ MySQL í˜¸í™˜ í˜•ì‹ ë³€í™˜
4. `AUTOINCREMENT` â†’ `AUTO_INCREMENT` ë³€í™˜
5. `varchar` â†’ `varchar(255)` ë³€í™˜
6. MySQL ì—°ê²° í›„ SQL ì‹¤í–‰ (ì¬ì‹œë„ 5íšŒ)

---

### `app/database/insert_db.py`
DB ì´ˆê¸° ë°ì´í„° ì‚½ì… ìŠ¤í¬ë¦½íŠ¸ (ë‚´ìš© ìµœì†Œí™”, ë³„ë„ êµ¬í˜„ ì˜ˆì •).

---

## ğŸ“ `app/scripts/` â€” ë°ì´í„° ì²˜ë¦¬ ìŠ¤í¬ë¦½íŠ¸

### `app/scripts/preprocess_data.py`
ë°ì´í„° ì „ì²˜ë¦¬ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

| í•¨ìˆ˜                           | ì„¤ëª…                                      |
| ------------------------------ | ----------------------------------------- |
| `download_image(url, timeout)` | URL ë˜ëŠ” Base64 ë¬¸ìì—´ì—ì„œ PIL Image ë¡œë“œ |
| `location_to_latlng(location)` | ë„¤ì´ë²„ Geocoding APIë¡œ ì£¼ì†Œ â†’ ìœ„ê²½ë„ ë³€í™˜ |

---

### `app/scripts/qdrant_setup.py`
Qdrant ë²¡í„° DB ì»¬ë ‰ì…˜ ìƒì„± ë° ë°ì´í„° ì ì¬ ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤.

**`QdrantClientDB` í´ë˜ìŠ¤:**

| ë©”ì„œë“œ                                                  | ì„¤ëª…                                                          |
| ------------------------------------------------------- | ------------------------------------------------------------- |
| `ensure_collections()`                                  | `places`, `photos` ì»¬ë ‰ì…˜ ì—†ìœ¼ë©´ ìƒì„± (HNSW ì¸ë±ìŠ¤ ì„¤ì • í¬í•¨) |
| `aggregate_vectors(vectors, top_k)`                     | ì´ë¯¸ì§€ ë²¡í„° ì—¬ëŸ¬ ê°œë¥¼ í‰ê·  ë‚´ì–´ ëŒ€í‘œ ë²¡í„° ìƒì„± (L2 ì •ê·œí™”)    |
| `add_place(place_id, description, image_urls, payload)` | ì¥ì†Œ 1ê°œë¥¼ í…ìŠ¤íŠ¸+ì´ë¯¸ì§€ ì„ë² ë”©í•˜ì—¬ Qdrantì— ì €ì¥             |
| `ingest_data(file_path)`                                | JSON íŒŒì¼ì„ ì½ì–´ ì „ì²´ ì¥ì†Œ ë°ì´í„° ì¼ê´„ ì ì¬                   |

**Qdrant ì»¬ë ‰ì…˜ êµ¬ì¡°:**

| ì»¬ë ‰ì…˜   | ë²¡í„°                                    | ì„¤ëª…                          |
| -------- | --------------------------------------- | ----------------------------- |
| `places` | `text_vec` (512d), `img_vec_agg` (512d) | ì¥ì†Œë³„ í…ìŠ¤íŠ¸+ëŒ€í‘œì´ë¯¸ì§€ ë²¡í„° |
| `photos` | ë‹¨ì¼ ë²¡í„° (512d)                        | ì¥ì†Œë³„ ê°œë³„ ì‚¬ì§„ ë²¡í„°         |

---

## ğŸ“ `data/`

### `data/visitkorea_data.json`
í•œêµ­ê´€ê´‘ê³µì‚¬ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìˆ˜ì§‘í•œ ê´€ê´‘ì§€ ì •ë³´ JSON íŒŒì¼ì…ë‹ˆë‹¤.

- íŒŒì¼ í¬ê¸°: ì•½ 363KB
- ì£¼ìš” í•„ë“œ: `id`, `name`, `ì£¼ì†Œ`, `photo_urls` ë“±
- `qdrant_setup.py`ì˜ `ingest_data()`ê°€ ì´ íŒŒì¼ì„ ì½ì–´ Qdrantì— ì ì¬í•©ë‹ˆë‹¤.

---

## ğŸ“ `tests/` â€” í…ŒìŠ¤íŠ¸

### `tests/conftest.py`
pytest ê³µí†µ í”½ìŠ¤ì²˜ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.

- **í…ŒìŠ¤íŠ¸ DB**: SQLite In-Memory (`sqlite:///:memory:`) ì‚¬ìš©
- `db` í”½ìŠ¤ì²˜: í…ŒìŠ¤íŠ¸ë§ˆë‹¤ í…Œì´ë¸” ìƒì„± â†’ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ â†’ í…Œì´ë¸” ì‚­ì œ
- `client` í”½ìŠ¤ì²˜: FastAPI `TestClient` + DB ì˜ì¡´ì„± ì˜¤ë²„ë¼ì´ë“œ

---

### `tests/test_auth.py`
ì¸ì¦ API í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤.

| í…ŒìŠ¤íŠ¸                      | ì„¤ëª…                                             |
| --------------------------- | ------------------------------------------------ |
| `test_login_google_success` | Google ë¡œê·¸ì¸ ì„±ê³µ ì‹œ í† í° ë°˜í™˜ í™•ì¸ (mock ì‚¬ìš©) |
| `test_login_google_failure` | ì˜ëª»ëœ ì½”ë“œë¡œ ë¡œê·¸ì¸ ì‹œ 400 ë°˜í™˜ í™•ì¸            |
| `test_refresh_token`        | Refresh Tokenìœ¼ë¡œ ìƒˆ Access Token ë°œê¸‰ í™•ì¸      |

---

### `tests/test_chat.py`
ì±„íŒ… API í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤.

| í…ŒìŠ¤íŠ¸                      | ì„¤ëª…                                  |
| --------------------------- | ------------------------------------- |
| `test_create_session`       | ì±„íŒ…ë°© ìƒì„± í™•ì¸                      |
| `test_get_sessions`         | ì±„íŒ…ë°© ëª©ë¡ ì¡°íšŒ í™•ì¸                 |
| `test_send_message_stream`  | ìŠ¤íŠ¸ë¦¬ë° ë©”ì‹œì§€ í…ŒìŠ¤íŠ¸ (ë¯¸êµ¬í˜„, pass) |
| `test_get_session_messages` | ì±„íŒ…ë°© ë©”ì‹œì§€ ëª©ë¡ ì¡°íšŒ í™•ì¸          |

---

### `tests/test_users.py`
ì‚¬ìš©ì API í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤.

| í…ŒìŠ¤íŠ¸                | ì„¤ëª…                       |
| --------------------- | -------------------------- |
| `test_read_users_me`  | í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ í™•ì¸ |
| `test_update_user_me` | ì‚¬ìš©ì ì •ë³´ ìˆ˜ì • í™•ì¸      |

---

## ğŸ”„ ì „ì²´ ìš”ì²­ íë¦„ ìš”ì•½

```
[í´ë¼ì´ì–¸íŠ¸]
    â”‚
    â–¼
[app/main.py] â† CORS, ë¡œê¹… ë¯¸ë“¤ì›¨ì–´
    â”‚
    â”œâ”€ /api/auth/*  â†’ [api/auth.py] â†’ [core/security.py] â†’ Google OAuth / JWT
    â”œâ”€ /api/users/* â†’ [api/users.py] â†’ [models/user.py]
    â””â”€ /api/chat/*  â†’ [api/chat.py]
                           â”‚
                           â”œâ”€ [retrieval/place.py] â†’ Qdrant ë²¡í„° ê²€ìƒ‰
                           â”‚       â””â”€ [scripts/preprocess_data.py] (ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ)
                           â”‚
                           â””â”€ [services/llm.py] â†’ OpenAI GPT-4o-mini
                                   â””â”€ [services/prompts.py] (ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸)
```

---

## ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡° ìš”ì•½

```
MySQL (ìš´ì˜ ë°ì´í„°)
â”œâ”€â”€ users          â† íšŒì› ì •ë³´, Google OAuth í† í°, ì„ í˜¸ë„ FK
â”œâ”€â”€ prefers        â† ì„ í˜¸ë„ ë§ˆìŠ¤í„° (ë°°ìš°, ì˜í™”, ë“œë¼ë§ˆ ë“±)
â”œâ”€â”€ chat_rooms     â† ì±„íŒ…ë°© (user_id FK)
â””â”€â”€ chat_messages  â† ë©”ì‹œì§€ (room_id FK, ìœ„ê²½ë„, ì´ë¯¸ì§€, ë¶ë§ˆí¬)

Qdrant (ë²¡í„° ê²€ìƒ‰)
â”œâ”€â”€ places         â† ì¥ì†Œë³„ text_vec + img_vec_agg (512d CLIP)
â””â”€â”€ photos         â† ì¥ì†Œë³„ ê°œë³„ ì‚¬ì§„ ë²¡í„° (512d CLIP)
```
